<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô - Admin Panel</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/performance.css" />
  <style>
  /* Make this page wider than default container */
  .container.container-wide { max-width: 1280px; }
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
    }
    .admin-nav {
      background: #2c3e50;
      padding: 15px 0;
      margin-bottom: 30px;
      border-radius: 8px;
    }
    .admin-nav .container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .admin-nav a {
      color: #ecf0f1;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-nav a:hover {
      background: #34495e;
      transform: translateY(-2px);
    }
    .admin-nav a.active {
      background: #3498db;
      box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
    }
    .exchange-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .exchange-table table tr {
      transition: background 0.2s ease, transform 0.08s ease;
    }
    .exchange-table table tr:hover {
      background: #f3f7ff;
    }
    .table-header {
      padding: 20px 25px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
      margin: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px 25px;
      text-align: left;
      border-bottom: 1px solid #f1f3f4;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    th:nth-child(1) { width: 80px; }
    th:nth-child(2), th:nth-child(3) { width: 14%; }
  th:nth-child(4), th:nth-child(5) { width: 22%; }
  th:nth-child(6) { width: 12%; }
      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap; /* keep Thai words like "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" on one line */
        line-height: 1; /* keep pill height compact */
        display: inline-flex; align-items: center; gap: 6px;
      }
  /* prevent wrapping in status column */
  td:nth-child(6), th:nth-child(6) { white-space: nowrap; }
    tr:hover {
      background: #f8f9fa;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    .status-approved, .status-accepted {
      background: #d4edda;
      color: #155724;
    }
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    .status-completed {
      background: #d1ecf1;
      color: #0c5460;
    }
    .no-exchanges {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    .no-exchanges h3 {
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .placeholder-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
      text-align: center;
    }
    .placeholder-info h3 {
      color: #1976d2;
      margin-bottom: 10px;
    }
    .placeholder-info p {
      color: #424242;
      margin: 5px 0;
    }
    .setup-instructions {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    .instruction-step {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .step-number {
      background: #3498db;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    .step-content h4 {
      margin: 0 0 8px 0;
      color: #2c3e50;
    }
    .step-content p {
      margin: 0;
      color: #6c757d;
      font-size: 14px;
    }
    .sql-code {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 10px 0;
      overflow-x: auto;
    }
    .chips { display:flex; gap:8px; flex-wrap:wrap; }
    .chip { background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; transition: all .2s ease; }
    .chip:hover { background:#e0e7ff; }
    .chip.active { background:#4338ca; color:#fff; border-color:#4338ca; }
    .action-btn { border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:13px; }
    .action-btn.btn-view { background:linear-gradient(135deg,#4f46e5,#06b6d4); color:#fff; }
    .action-btn.btn-edit { background:#f3f4f6; color:#111827; border:1px solid #e5e7eb; }
    .pagination a { border:1px solid #e5e7eb; padding:8px 12px; border-radius:8px; background:#fff; color:#111827; text-decoration:none; }
    .pagination a.active { background:#4f46e5; color:#fff; border-color:#4f46e5; }
    .pagination { display:flex; gap:8px; justify-content:center; padding:16px; }
  </style>
</head>
<body>
  <%- include('../partials/admin_header', { showAdminSearch: false }) %>

  <main class="container container-wide">
    <% if (typeof currentFilterUserId !== 'undefined' && currentFilterUserId) { %>
      <div class="placeholder-info" style="margin-top: -10px; margin-bottom: 20px;">
        <h3>üìú ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ID <%= currentFilterUserId %></h3>
        <p>‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</p>
        <a class="action-btn btn-edit" href="/admin/exchanges" style="margin-top:8px; display:inline-block">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</a>
      </div>
    <% } %>
    <% if (!exchanges || exchanges.length === 0) { %>
      <!-- Placeholder when no exchange system exists -->
      <div class="placeholder-info">
        <h3>üí° ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
        <p>‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á exchange_requests ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        <p>‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
      </div>

      <div class="setup-instructions">
        <h3 style="margin-bottom: 20px; color: #2c3e50;">üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</h3>
        
        <div class="instruction-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h4>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á exchange_requests</h4>
            <p>‡∏£‡∏±‡∏ô SQL ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô phpMyAdmin ‡∏´‡∏£‡∏∑‡∏≠ MySQL Client:</p>
            <div class="sql-code">
CREATE TABLE exchange_requests (
  id INT AUTO_INCREMENT PRIMARY KEY,
  requester_id INT NOT NULL,
  owner_id INT NOT NULL,
  requested_book_id INT NOT NULL,
  offered_book_id INT NULL,
  message TEXT,
  status ENUM('pending', 'approved', 'rejected', 'completed') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (requester_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (requested_book_id) REFERENCES books(id) ON DELETE CASCADE,
  FOREIGN KEY (offered_book_id) REFERENCES books(id) ON DELETE SET NULL
);
            </div>
          </div>
        </div>

        <div class="instruction-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h4>‡∏™‡∏£‡πâ‡∏≤‡∏á Exchange Controller</h4>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏ô exchangeController.js</p>
          </div>
        </div>

        <div class="instruction-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h4>‡πÄ‡∏û‡∏¥‡πà‡∏° Routes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</h4>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</p>
          </div>
        </div>

        <div class="instruction-step">
          <div class="step-number">4</div>
          <div class="step-content">
            <h4>‡πÄ‡∏û‡∏¥‡πà‡∏° UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h4>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</p>
          </div>
        </div>
      </div>

      <div style="text-align: center; margin: 30px 0;">
        <a href="/debug" class="action-btn btn-view" style="margin-right: 10px;">üîç ‡∏î‡∏π Debug Database</a>
        <a href="/admin" class="action-btn btn-edit">‚Üê ‡∏Å‡∏•‡∏±‡∏ö Dashboard</a>
      </div>

    <% } else { %>
      <!-- Show exchanges when they exist -->
      <div class="exchange-table">
        <div class="table-header">
          <h2 class="table-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</h2>
          <div class="table-filters">
            <div class="chips" id="status-chips">
              <button class="chip active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              <button class="chip" data-filter="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
              <button class="chip" data-filter="accepted">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button class="chip" data-filter="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
              <button class="chip" data-filter="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
            </div>
          </div>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å</th>
              <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th>
              <th>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
              <th>‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody>
            <% exchanges.forEach(function(exchange) { %>
              <tr data-status="<%= exchange.status %>">
                <td>#<%= exchange.id %></td>
                <td><span class="truncate" title="<%= exchange.requester_username %>"><%= exchange.requester_username %></span></td>
                <td><span class="truncate" title="<%= exchange.owner_username %>"><%= exchange.owner_username %></span></td>
                <td><span class="truncate" title="<%= exchange.requested_book_title %>"><%= exchange.requested_book_title %></span></td>
                <td><span class="truncate" title="<%= exchange.offered_book_title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %>"><%= exchange.offered_book_title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %></span></td>
                <td>
                  <% const _statusText = (s => s==='pending'?'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': s==='accepted'?'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥': s==='rejected'?'‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò': s==='completed'?'‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': s)(exchange.status); %>
                  <% const _statusClass = exchange.status === 'accepted' ? 'status-approved' : ('status-' + exchange.status); %>
                  <span class="status-badge <%= _statusClass %>"><%= _statusText %></span>
                </td>
                <td><%= new Date(exchange.created_at).toLocaleString('th-TH') %></td>
                <td style="display:flex; gap:8px; align-items:center;">
      <button class="action-btn btn-view" data-view-exchange="<%= exchange.id %>">‡∏î‡∏π</button>
          <a class="action-btn btn-edit" href="/admin/exchanges?userId=<%= exchange.requester_id %>">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</a>
          <a class="action-btn btn-edit" href="/admin/exchanges?userId=<%= exchange.book_owner_id %>">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</a>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>

      <div id="filter-empty" class="no-exchanges" style="display:none;">
        <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
        <p>‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
      </div>

      <!-- Pagination -->
      <% if (totalPages > 1) { %>
        <div class="pagination">
          <% if (currentPage > 1) { %>
            <a href="?page=<%= currentPage - 1 %><%= currentFilterUserId ? '&userId=' + currentFilterUserId : '' %>">‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
          <% } %>
          
          <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="?page=<%= i %><%= currentFilterUserId ? '&userId=' + currentFilterUserId : '' %>" class="<%= i === currentPage ? 'active' : '' %>"><%= i %></a>
          <% } %>
          
          <% if (currentPage < totalPages) { %>
            <a href="?page=<%= currentPage + 1 %><%= currentFilterUserId ? '&userId=' + currentFilterUserId : '' %>">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</a>
          <% } %>
        </div>
      <% } %>
    <% } %>
  </main>

  <footer class="site-footer" style="background:linear-gradient(135deg,#4f46e5,#06b6d4); color:white; margin-top:40px; padding:18px 0;">
    <div class="container footer-bottom" style="display:flex; justify-content:space-between; align-items:center;">
      <div class="copyright">Admin Panel - SwapABook <%= new Date().getFullYear() %></div>
      <div style="font-size:13px; opacity:0.95;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</div>
    </div>
  </footer>

  

  <script src="/js/performance.js"></script>
  <script>
    // View exchange details
    function viewExchange(exchangeId) {
      // Fetch JSON then populate and open modal
      fetch(`/admin/exchanges/${exchangeId}.json`, { credentials: 'same-origin' })
        .then(res => res.json())
        .then(data => {
          if (!data || !data.success) {
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ');
            return;
          }
          renderExchangeModal(data.request, data.timeline, data.history);
        })
        .catch(() => alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'));
    }

    // Attach click handlers without inline JS to avoid linter warnings
    document.querySelectorAll('[data-view-exchange]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.getAttribute('data-view-exchange'), 10);
        if (!Number.isNaN(id)) viewExchange(id);
      });
    });

    // Modal rendering
    function ensureModal() {
      let modal = document.getElementById('exchange-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'exchange-modal';
        modal.innerHTML = `
<div class="modal-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:9998"></div>
<div class="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999">
  <div class="modal-card" style="background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:min(900px,92vw);max-height:85vh;display:flex;flex-direction:column;">
    <div class="modal-header" style="padding:16px 20px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;gap:8px">
      <h3 id="ex-title" style="margin:0;font-size:18px;color:#111827;flex:1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</h3>
      <a id="ex-open-full" href="#" class="action-btn btn-view" style="text-decoration:none">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°</a>
      <button id="ex-close" class="action-btn" style="background:#e5e7eb;color:#111827;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body" style="padding:16px 20px;overflow:auto">
      <div id="ex-summary" style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start"></div>
      <div style="margin-top:16px">
        <h4 style="margin:0 0 8px 0;font-size:16px">‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</h4>
        <ol id="ex-timeline" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px"></ol>
      </div>
    </div>
  </div>
</div>`;
        document.body.appendChild(modal);
        const close = () => { modal.querySelector('.modal').style.display='none'; modal.querySelector('.modal-backdrop').style.display='none'; };
        modal.querySelector('#ex-close').addEventListener('click', close);
        modal.querySelector('.modal-backdrop').addEventListener('click', close);
      }
      return modal;
    }

    function renderExchangeModal(req, timeline, history) {
      const modal = ensureModal();
      const m = modal.querySelector('.modal');
      const b = modal.querySelector('.modal-backdrop');
      modal.querySelector('#ex-title').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô #${req.id}`;
      const openFull = modal.querySelector('#ex-open-full');
      openFull.setAttribute('href', `/admin/exchanges/${req.id}`);

      const statusMap = {
        pending: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
        accepted: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
        rejected: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
        completed: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'
      };

      // Summary two-column
      const left = `
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span class="status-badge status-${req.status || 'pending'}">${statusMap[req.status] || req.status}</span>
          <span style="font-size:12px;color:#6b7280">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${req.created_at ? new Date(req.created_at).toLocaleString('th-TH') : '-'}</span>
        </div>
        <div style="display:flex;gap:12px">
          <div style="flex:1;background:#f9fafb;border:1px solid #eee;border-radius:8px;padding:10px;">
            <div style="font-weight:600;margin-bottom:6px">‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å</div>
            <div style="font-size:14px;color:#111827">${req.requester_username || '-'}</div>
          </div>
          <div style="flex:1;background:#f9fafb;border:1px solid #eee;border-radius:8px;padding:10px;">
            <div style="font-weight:600;margin-bottom:6px">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</div>
            <div style="font-size:14px;color:#111827">${req.owner_username || '-'}</div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1;border:1px solid #eee;border-radius:8px;padding:10px;display:flex;gap:10px;align-items:center">
            <img src="${req.requested_book_thumbnail || '/images/placeholder.png'}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:6px;border:1px solid #e5e7eb"/>
            <div>
              <div style="font-size:12px;color:#6b7280">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</div>
              <div style="font-weight:600">${req.requested_book_title || '-'}</div>
            </div>
          </div>
          <div style="flex:1;border:1px solid #eee;border-radius:8px;padding:10px;display:flex;gap:10px;align-items:center">
            <img src="${req.offered_book_thumbnail || '/images/placeholder.png'}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:6px;border:1px solid #e5e7eb"/>
            <div>
              <div style="font-size:12px;color:#6b7280">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠</div>
              <div style="font-weight:600">${req.offered_book_title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
            </div>
          </div>
        </div>

        ${req.message ? `<div style="margin-top:12px"><div style="font-size:12px;color:#6b7280">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div><div>${(req.message+'').replace(/</g,'&lt;')}</div></div>` : ''}
      </div>`;

      const right = `
      <div>
        <div style="background:#f9fafb;border:1px solid #eee;border-radius:8px;padding:10px">
          <div style="font-size:12px;color:#6b7280">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div style="font-weight:600">${req.updated_at ? new Date(req.updated_at).toLocaleString('th-TH') : '-'}</div>
          <div style="font-size:12px;color:#6b7280;margin-top:6px">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠</div>
          <div style="font-weight:600">${req.completed_at ? new Date(req.completed_at).toLocaleString('th-TH') : '-'}</div>
        </div>
      </div>`;

      modal.querySelector('#ex-summary').innerHTML = left + right;

      // Timeline
      const tl = modal.querySelector('#ex-timeline');
      const icon = t => ({
        created: 'üìù', accepted: '‚úÖ', rejected: '‚ùå', completed: 'üéâ', history: 'üìö'
      })[t] || '‚Ä¢';
      tl.innerHTML = '';
      (timeline || []).sort((a,b)=> new Date(a.at)-new Date(b.at)).forEach(item => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.gap = '8px';
        li.style.alignItems = 'center';
        li.innerHTML = `<span style="width:20px;text-align:center">${icon(item.type)}</span>
                        <span style="flex:1">${item.label}</span>
                        <span style="font-size:12px;color:#6b7280">${item.at ? new Date(item.at).toLocaleString('th-TH') : ''}</span>`;
        tl.appendChild(li);
      });

      m.style.display = 'flex';
      b.style.display = 'block';
    }

    // Client-side status filter (visual only)
    (function(){
      const chips = document.querySelectorAll('#status-chips .chip');
      const rows = Array.from(document.querySelectorAll('tbody tr[data-status]'));
      const empty = document.getElementById('filter-empty');
      function applyFilter(st){
        let visible = 0;
        rows.forEach(r => {
          const ok = (st === 'all') || (r.getAttribute('data-status') === st);
          r.style.display = ok ? '' : 'none';
          if (ok) visible++;
        });
        if (empty) empty.style.display = visible === 0 ? 'block' : 'none';
      }
      chips.forEach(ch => ch.addEventListener('click', () => {
        chips.forEach(c => c.classList.remove('active'));
        ch.classList.add('active');
        applyFilter(ch.getAttribute('data-filter'));
      }));
      // initial filter is 'all'
      applyFilter('all');
    })();

    console.log('Admin Exchange Management loaded');
  </script>
</body>
</html>