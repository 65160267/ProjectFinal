<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>All Books</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/performance.css" />
    <style>
      /* Keep cards equal height and align action buttons on the same baseline */
      .product-grid { align-items: stretch; }
      /* Make the white card frame taller and more proportional */
      .product-card { display: flex; flex-direction: column; min-height: 420px; }
      .product-body { display: flex; flex-direction: column; flex: 1; }
      .product-actions { margin-top: auto; display: flex; justify-content: center; padding-top: 6px; gap: 10px; }
      /* Slight bump for thumbnail to match Dashboard proportion */
      .product-thumb { height: 200px; }

      .btn-action-primary {
        background: linear-gradient(135deg, #ffb37b, #ff8a4d);
        color: #fff;
        padding: 10px 18px;
        border-radius: 14px;
        text-decoration: none;
        font-weight: 700;
        box-shadow: 0 8px 24px rgba(255,138,77,0.3);
        border: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-action-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(255,138,77,0.35);
      }

      .btn-action-secondary {
        background: rgba(255, 255, 255, 0.9);
        color: var(--muted);
        padding: 10px 18px;
        border-radius: 14px;
        text-decoration: none;
        font-weight: 700;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-action-secondary:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      }

      @media (max-width: 600px) {
        .product-actions {
          flex-direction: column;
        }
        .btn-action-primary,
        .btn-action-secondary {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="site-header">
      <div class="header-inner container">
        <div class="brand">
          <a href="/dashboard" class="brand">
            SwapABook
          </a>
        </div>
        <nav class="header-actions">
          <a href="/dashboard" title="Home">üè†</a>
          <a href="/books" title="Cart">üõçÔ∏è</a>
          <a href="/messages" title="Messages">üí¨</a>
          <% if (typeof user !== 'undefined' && user && user.username) { %>
            <a href="/user" class="header-user" title="Your profile">
              <img class="user-avatar" 
                   src="<%= (user.avatar && user.avatar.startsWith('/')) ? user.avatar : (user.avatar ? '/uploads/' + user.avatar : '/images/profile-placeholder.svg') %>" 
                   alt="Profile" 
                   onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22 viewBox=%220 0 150 150%22%3E%3Crect width=%22150%22 height=%22150%22 fill=%22%23f0f0f0%22/%3E%3Ccircle cx=%2275%22 cy=%2260%22 r=%2225%22 fill=%22%23ddd%22/%3E%3Cpath d=%22M30 130 Q30 100 50 100 L100 100 Q120 100 120 130 Z%22 fill=%22%23ddd%22/%3E%3C/svg%3E'" />
            </a>
            <a href="/auth/logout" title="Logout">üîì</a>
          <% } else { %>
            <a href="/auth/login" title="Login">üîì</a>
          <% } %>
        </nav>
      </div>
    </header>

    <main class="container marketplace-main">
      <aside class="market-sidebar card">
        <h3>Marketplace</h3>
        <ul style="list-style: none; padding: 0; margin: 0;">
          <li style="margin-bottom: 8px;">
            <a href="/dashboard" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; text-decoration: none; border-radius: 8px; font-weight: 600; color: var(--accent-700);">
              üè† <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
          </li>
          <li style="margin-bottom: 8px;">
            <a href="/books" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; text-decoration: none; border-radius: 8px; font-weight: 600; color: var(--muted); background: var(--accent-100);">
              üìö <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
            </a>
          </li>
          <li style="margin-bottom: 8px;">
              <a href="/books/new" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; text-decoration: none; border-radius: 8px; font-weight: 600; color: #667eea;">
                ‚ûï <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
              </a>
            </li>
        </ul>
      </aside>
      <section class="market-content">
        <div class="card">
          <h2><%= pageTitle || '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' %></h2>
          <div class="product-grid">
            <% if (books && books.length) { %>
              <% books.forEach(function(b) { %>
                <div class="product-card">
                  <div class="product-thumb" data-thumb="<%= b.thumbnail || '/images/placeholder.png' %>"></div>
                  <div class="product-body">
                    <div class="product-title"><a href="/books/<%= b.id %>"><%= b.title %></a></div>
                    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                      <div class="product-tags">‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö: <span class="badge"><%= b.tags || 'n/a' %></span></div>
                      <% if (b.condition) { %>
                        <div class="pill condition"><%= (b.condition === 'new' ? '‡πÉ‡∏´‡∏°‡πà' : (b.condition === 'good' ? '‡∏î‡∏µ' : '‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')) %></div>
                      <% } %>
                    </div>
                    <div class="product-meta" style="margin-top:6px"><%= b.location || 'Unknown' %></div>
                    <div class="product-actions">
                      <a class="btn-action-primary" href="/books/<%= b.id %>">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
                      <a class="btn-action-secondary" href="/books/<%= b.id %>/edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <p class="muted empty-state">No books found.</p>
            <% } %>
          </div>
          
          <!-- Pagination -->
          <% if (typeof pagination !== 'undefined' && pagination.totalPages > 1) { %>
            <div class="pagination-container" style="margin-top: 30px; text-align: center;">
              <div class="pagination">
                <% if (pagination.hasPrevPage) { %>
                  <a href="<%= (basePath || '/books') %>?page=<%= pagination.prevPage %>" class="btn btn-ghost">‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
                <% } %>
                
                <span class="pagination-info">
                  ‡∏´‡∏ô‡πâ‡∏≤ <%= pagination.currentPage %> ‡∏à‡∏≤‡∏Å <%= pagination.totalPages %>
                </span>
                
                <% if (pagination.hasNextPage) { %>
                  <a href="<%= (basePath || '/books') %>?page=<%= pagination.nextPage %>" class="btn btn-ghost">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</a>
                <% } %>
              </div>
            </div>
          <% } %>
        </div>
      </section>
    </main>



    <script>
      document.querySelectorAll('.product-thumb[data-thumb]').forEach(el => {
        const url = el.getAttribute('data-thumb') || '/images/placeholder.png';
        el.style.backgroundImage = `url(${url})`;
      });
    </script>
    
    <!-- Lazy loading script for performance -->
    <script src="/js/lazy-loading.js"></script>
    
    <%- include('../partials/footer_unified') %>
    <%- include('../partials/report_footer') %>
  </body>
</html>
