<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Swap A Book ‚Äî Dashboard</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/performance.css" />
    <style>
      /* Ensure cards have consistent heights and actions sit at the bottom */
      .product-grid { align-items: stretch; }
      .product-card { display: flex; flex-direction: column; height: 100%; }
      .product-body { display: flex; flex-direction: column; flex: 1; }
      .product-actions { margin-top: auto; display: flex; justify-content: center; padding-top: 6px; }
    </style>
  </head>
  <body>
    <% 
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà controller ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤ (‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î ReferenceError)
      if (typeof featured === 'undefined') featured = [];
      if (typeof recommendedA === 'undefined') recommendedA = [];
      if (typeof recommendedB === 'undefined') recommendedB = [];
      if (typeof books === 'undefined') books = [];
    %>
    <!-- Header -->
    <header class="site-header">
      <div class="header-inner container">
        <div class="brand">
          <a href="/dashboard" class="brand">
            SwapABook
          </a>
        </div>
        <form class="search" action="/" method="get">
          <input name="q" placeholder="Search for books" />
          <button type="submit">üîç</button>
        </form>
        <nav class="header-actions">
          <a href="/books" title="Cart">üõçÔ∏è</a>
          <a href="/messages" title="Messages">üí¨</a>
          <% if (typeof user !== 'undefined' && user && user.username) { %>
            <a href="/user" class="header-user" title="Your profile">
              <img class="user-avatar" 
                   src="<%= (user.avatar && user.avatar.startsWith('/')) ? user.avatar : (user.avatar ? '/uploads/' + user.avatar : '/images/profile-placeholder.svg') %>" 
                   alt="Profile" 
                   onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22 viewBox=%220 0 150 150%22%3E%3Crect width=%22150%22 height=%22150%22 fill=%22%23f0f0f0%22/%3E%3Ccircle cx=%2275%22 cy=%2260%22 r=%2225%22 fill=%22%23ddd%22/%3E%3Cpath d=%22M30 130 Q30 100 50 100 L100 100 Q120 100 120 130 Z%22 fill=%22%23ddd%22/%3E%3C/svg%3E'" />
              <span class="username"><%= user.username %></span>
            </a>
            <a href="/auth/logout" title="Logout">üîì</a>
          <% } else { %>
            <a href="/auth/login" title="Login">üîì</a>
          <% } %>
        </nav>
      </div>
    </header>

    <main class="container marketplace-main">
      <aside class="market-sidebar card">
        <!-- User Profile Section -->
        <% if (typeof user !== 'undefined' && user && user.username) { %>
          <div style="padding: 16px; background: linear-gradient(135deg, var(--accent), var(--accent-600)); border-radius: 12px; margin-bottom: 16px; color: white; text-align: center;">
            <div style="margin-bottom: 12px;">
              <img src="<%= (user.avatar && user.avatar.startsWith('/')) ? user.avatar : (user.avatar ? '/uploads/' + user.avatar : '/images/profile-placeholder.svg') %>" 
                   alt="Profile" 
                   style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2);" 
                   onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22 viewBox=%220 0 150 150%22%3E%3Crect width=%22150%22 height=%22150%22 fill=%22%23f0f0f0%22/%3E%3Ccircle cx=%2275%22 cy=%2260%22 r=%2225%22 fill=%22%23ddd%22/%3E%3Cpath d=%22M30 130 Q30 100 50 100 L100 100 Q120 100 120 130 Z%22 fill=%22%23ddd%22/%3E%3C/svg%3E'" />
            </div>
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">
              <%= user.full_name || user.username %>
            </div>
            <div style="font-size: 13px; opacity: 0.9;">
              @<%= user.username %>
            </div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
              üìç <%= user.location || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà' %>
            </div>
            <div style="margin-top: 12px;">
              <a href="/user" style="background: rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600;">
                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
              </a>
            </div>
          </div>
        <% } %>

        <ul style="list-style: none; padding: 0; margin: 0;">
          <li style="margin-bottom: 8px;">
            <a href="/dashboard" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--accent-100); color: var(--accent-700); text-decoration: none; border-radius: 8px; font-weight: 600;">
              üè† <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
          </li>
          <li style="margin-bottom: 8px;">
            <a href="/books" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; color: var(--muted); text-decoration: none; border-radius: 8px;">
              ÔøΩ <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
            </a>
          </li>
          <% if (typeof user !== 'undefined' && user && user.id) { %>
            <li style="margin-bottom: 8px;">
              <a href="/books/new" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--success); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; border: none; outline: none;">
                ‚ûï <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
              </a>
            </li>
          <% } %>
          <% if (typeof user !== 'undefined' && user && user.isAdmin) { %>
            <li style="margin-bottom: 8px;">
              <a href="/admin" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                üõ†Ô∏è <span>Admin Panel</span>
              </a>
            </li>
          <% } %>
        </ul>

        <!-- Quick Stats -->
        <%- include('partials/user_stats') %>
      </aside>

      <section class="market-content">
        <!-- Welcome Section -->
        <% if (typeof user !== 'undefined' && user && user.username) { %>
          <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px; text-align: center; padding: 24px;">
            <h1 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 800;">
              üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, <%= user.full_name || user.username %>!
            </h1>
            <p style="margin: 0; opacity: 0.9; font-size: 16px;">
              ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?
            </p>
            <div style="margin-top: 16px;">
              <a href="/books/new" style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: 600; margin-right: 8px;">
                üìñ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
              </a>
              <a href="/books" style="background: transparent; color: white; padding: 12px 24px; border: 2px solid rgba(255,255,255,0.3); border-radius: 25px; text-decoration: none; font-weight: 600;">
                üìö ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
              </a>
            </div>
          </div>
        <% } %>
        
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0; color: var(--muted);">üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
            <div style="font-size: 13px; color: var(--muted);">
              üìà ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <%= new Date().toLocaleDateString('th-TH') %>
            </div>
          </div>
          <input class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏ô‡πÉ‡∏à..." style="margin-bottom: 16px;" />
          <div class="product-grid">
            <% if (books && books.length) { %>
              <% books.forEach(function(b, index) { %>
                <div class="product-card" style="position: relative; overflow: hidden; border: 1px solid #f0f0f0;">
                  <!-- New Badge for recent items -->
                  <% if (index < 3) { %>
                    <div style="position: absolute; top: 8px; right: 8px; background: #ff4757; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; z-index: 2;">
                      üÜï ‡πÉ‡∏´‡∏°‡πà
                    </div>
                  <% } %>
                  
                  <div class="product-thumb" data-thumb="<%= b.thumbnail || '/images/placeholder.png' %>" style="position: relative;">
                    <!-- Gradient overlay for better text readability -->
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); height: 40px;"></div>
                  </div>
                  
                  <div class="product-body" style="padding: 14px;">
                    <div class="product-title" style="font-weight: 700; color: var(--muted); margin-bottom: 8px; font-size: 16px;">
                      üìñ <%= b.title || '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠' %>
                    </div>
                    
                    <!-- Tags and Condition Row -->
                    <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
                      <span style="font-size: 12px; color: var(--muted);">üîÑ ‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö:</span>
                      <span class="badge" style="font-size: 11px;"><%= b.tags || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %></span>
                      <% if (b.condition) { %>
                        <span class="pill condition" style="font-size: 11px;">
                          <%= (b.condition === 'new' ? '‚ú® ‡πÉ‡∏´‡∏°‡πà' : (b.condition === 'good' ? 'üëç ‡∏î‡∏µ' : 'üìù ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')) %>
                        </span>
                      <% } %>
                    </div>
                    
                    <!-- Location -->
                    <div class="product-meta" style="margin-bottom: 12px; font-size: 13px; color: #666;">
                      üìç <%= b.location || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà' %>
                    </div>
                    
                    <!-- Action Button -->
                    <div class="product-actions">
                      <a class="btn btn-primary" href="/books/<%= b.id %>" 
                         title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î <%= b.title %>"
                         style="display: inline-block; font-size: 13px; padding: 10px 16px; border-radius: 10px;">
                        üëÄ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                      </a>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div style="text-align: center; padding: 40px; color: var(--muted);">
                <div style="font-size: 48px; margin-bottom: 16px;">üìö</div>
                <h3 style="margin-bottom: 8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h3>
                <p style="margin-bottom: 20px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!</p>
                <% if (typeof user !== 'undefined' && user && user.id) { %>
                  <a href="/books/new" class="btn btn-primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</a>
                <% } else { %>
                  <a href="/auth/login" class="btn btn-primary">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</a>
                <% } %>
              </div>
            <% } %>
          </div>
        </div>
      </section>
    </main>

    <%- include('partials/footer_unified') %>

  <%- include('partials/report_footer') %>

    <style>
      /* Enhanced Dashboard Styles */
      .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        border-color: var(--accent);
      }
      

      
      .market-sidebar ul li a:hover {
        background-color: var(--accent-100) !important;
        color: var(--accent-700) !important;
        transform: translateX(4px);
      }
      
      .search-input:focus {
        box-shadow: 0 0 0 3px rgba(246, 169, 122, 0.2);
        border-color: var(--accent);
      }
      
      /* Performance optimized - transitions removed */
      
      /* Welcome section animation */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .card {
        animation: fadeInUp 0.6s ease;
      }
    </style>

    <script>
      // Enhanced image loading with fade-in effect
      document.querySelectorAll('.thumb[data-thumb], .small-thumb[data-thumb], .product-thumb[data-thumb]').forEach(el => {
        const url = el.getAttribute('data-thumb') || '/images/placeholder.png';
        el.style.backgroundImage = `url(${url})`;
        el.style.opacity = '0';
        // Simulate image loading
        const img = new Image();
        img.onload = () => {
          el.style.opacity = '1';
        };
        img.src = url;
      });

      // Enhanced profile image loading
      document.querySelectorAll('img[src*="/uploads/"], img[src*="profile-placeholder"]').forEach(img => {
        img.addEventListener('load', function() {
          this.style.opacity = '1';
        });
        img.addEventListener('error', function() {
          console.log('Image failed to load:', this.src);
          this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22 viewBox=%220 0 150 150%22%3E%3Crect width=%22150%22 height=%22150%22 fill=%22%23f0f0f0%22/%3E%3Ccircle cx=%2275%22 cy=%2260%22 r=%2225%22 fill=%22%23ddd%22/%3E%3Cpath d=%22M30 130 Q30 100 50 100 L100 100 Q120 100 120 130 Z%22 fill=%22%23ddd%22/%3E%3C/svg%3E';
        });
      });

      // Search functionality
      const searchInput = document.querySelector('.search-input');
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          const query = e.target.value.toLowerCase();
          const cards = document.querySelectorAll('.product-card');
          
          cards.forEach(card => {
            const title = card.querySelector('.product-title').textContent.toLowerCase();
            const tags = card.querySelector('.badge').textContent.toLowerCase();
            
            if (title.includes(query) || tags.includes(query)) {
              card.style.display = 'block';
              card.style.animation = 'fadeInUp 0.3s ease';
            } else {
              card.style.display = 'none';
            }
          });
        });
      }

      // Add welcome message animation delay
      setTimeout(() => {
        const welcomeSection = document.querySelector('[style*="background: linear-gradient(135deg, #667eea"]');
        if (welcomeSection) {
          // Animation removed for performance optimization
        }
      }, 500);
    </script>

    <!-- Lazy loading script for performance -->
    <script src="/js/lazy-loading.js"></script>
    
    <!-- Avatar handler for fallback images -->
    <script src="/js/avatar-handler.js"></script>

  </body>
</html>
